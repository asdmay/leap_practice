var DTW = require('./dtw.js');
var $ = require('jquery');
var Leap = require('leapjs');
var Sketch = require('./sketch.js');
var showColor = '#87ceeb';
var drawColor = '#000080';
var sketch = new Sketch('sketch');

var sample = [ { x: -169.897, y: 110.723, z: 9.71903 },
	       { x: -170.507, y: 111.062, z: 10.4725 },
	       { x: -170.617, y: 111.308, z: 11.0072 },
	       { x: -170.955, y: 111.776, z: 11.1872 },
	       { x: -171.076, y: 112.004, z: 11.4294 },
	       { x: -175.522, y: 107.898, z: 5.41265 },
	       { x: -180.677, y: 108.086, z: 2.8646 },
	       { x: -182.06, y: 108.587, z: 0.742934 },
	       { x: -182.121, y: 109.74, z: 1.86046 },
	       { x: -182.16, y: 110.446, z: 2.65619 },
	       { x: -180.645, y: 114.183, z: 4.17831 },
	       { x: -178.684, y: 113.5, z: 3.58282 },
	       { x: -178.22, y: 112.636, z: 3.19227 },
	       { x: -175.174, y: 112.583, z: 10.0256 },
	       { x: -173.106, y: 110.688, z: 5.83266 },
	       { x: -170.223, y: 111.594, z: 7.03603 },
	       { x: -167.4, y: 111.88, z: 5.2312 },
	       { x: -163.993, y: 110.809, z: 3.98124 },
	       { x: -159.691, y: 110.152, z: 2.01416 },
	       { x: -155.268, y: 107.407, z: -1.69046 },
	       { x: -150.912, y: 105.941, z: -3.85341 },
	       { x: -147.709, y: 105.544, z: -6.39012 },
	       { x: -143.554, y: 106.632, z: -7.85637 },
	       { x: -139.914, y: 107.652, z: -9.79192 },
	       { x: -134.908, y: 110.107, z: -5.5642 },
	       { x: -129.643, y: 112.352, z: -2.97844 },
	       { x: -126.066, y: 111.513, z: -4.11704 },
	       { x: -122.622, y: 110.114, z: -7.16365 },
	       { x: -119.12, y: 109.51, z: -10.5297 },
	       { x: -115.24, y: 109.47, z: -12.3013 },
	       { x: -111.66, y: 109.433, z: -13.4373 },
	       { x: -108.729, y: 109.616, z: -14.3415 },
	       { x: -104.512, y: 111.758, z: -10.6368 },
	       { x: -102.659, y: 112.409, z: -10.3111 },
	       { x: -100.181, y: 113.121, z: -11.0817 },
	       { x: -97.5108, y: 113.429, z: -11.8019 },
	       { x: -94.9407, y: 113.89, z: -12.5438 },
	       { x: -91.9617, y: 114.12, z: -13.7771 },
	       { x: -89.8463, y: 114.531, z: -14.6595 },
	       { x: -87.2707, y: 114.929, z: -15.2296 },
	       { x: -87.2707, y: 114.929, z: -15.2296 },
	       { x: -84.5202, y: 115.728, z: -16.9571 },
	       { x: -82.9907, y: 115.862, z: -17.2954 },
	       { x: -80.2604, y: 116.242, z: -17.4631 },
	       { x: -78.2424, y: 116.9, z: -17.4881 },
	       { x: -77.0874, y: 117.178, z: -17.4794 },
	       { x: -75.5218, y: 117.8, z: -17.5202 },
	       { x: -74.9125, y: 117.841, z: -17.7967 },
	       { x: -73.8302, y: 117.969, z: -18.2984 },
	       { x: -73.2454, y: 118.027, z: -18.4822 },
	       { x: -72.1609, y: 118.064, z: -18.6806 },
	       { x: -71.8731, y: 118.102, z: -18.7919 },
	       { x: -71.456, y: 118.243, z: -18.8304 },
	       { x: -71.0769, y: 118.463, z: -18.8985 },
	       { x: -70.8378, y: 118.54, z: -18.9039 },
	       { x: -70.5883, y: 118.703, z: -18.8815 },
	       { x: -70.491, y: 118.809, z: -18.841 },
	       { x: -70.4999, y: 118.893, z: -18.8262 },
	       { x: -70.483, y: 119, z: -18.8129 },
	       { x: -70.4675, y: 119.122, z: -18.8041 },
	       { x: -70.5464, y: 119.718, z: -18.4996 },
	       { x: -70.6924, y: 120.004, z: -18.4351 },
	       { x: -70.8143, y: 120.233, z: -18.4414 },
	       { x: -71.0289, y: 120.457, z: -18.5468 },
	       { x: -71.1865, y: 120.621, z: -18.6292 },
	       { x: -71.2893, y: 120.765, z: -18.642 },
	       { x: -71.4745, y: 120.864, z: -18.585 },
	       { x: -71.6967, y: 120.869, z: -18.2453 },
	       { x: -71.6967, y: 120.869, z: -18.2453 },
	       { x: -71.9159, y: 120.844, z: -17.8973 },
	       { x: -72.0703, y: 120.783, z: -17.6801 },
	       { x: -72.1519, y: 120.547, z: -17.5317 },
	       { x: -72.2236, y: 120.439, z: -17.5014 },
	       { x: -72.4173, y: 120.4, z: -17.4984 },
	       { x: -72.4173, y: 120.4, z: -17.4984 },
	       { x: -72.7098, y: 120.283, z: -17.5789 },
	       { x: -72.8828, y: 120.08, z: -17.6608 },
	       { x: -72.9969, y: 119.935, z: -17.7296 },
	       { x: -73.1199, y: 119.809, z: -17.854 },
	       { x: -73.1199, y: 119.809, z: -17.854 },
	       { x: -73.259, y: 119.713, z: -17.9284 },
	       { x: -73.3328, y: 119.64, z: -17.9873 },
	       { x: -73.384, y: 119.584, z: -18.0439 },
	       { x: -73.384, y: 119.584, z: -18.0439 },
	       { x: -73.3923, y: 119.53, z: -17.9634 },
	       { x: -73.4079, y: 119.541, z: -17.9451 },
	       { x: -73.4185, y: 119.551, z: -17.9238 },
	       { x: -73.4124, y: 119.579, z: -17.8825 },
	       { x: -73.4124, y: 119.579, z: -17.8825 },
	       { x: -73.423, y: 119.583, z: -17.8341 },
	       { x: -73.4289, y: 119.598, z: -17.8065 },
	       { x: -73.4184, y: 119.614, z: -17.811 },
	       { x: -73.4184, y: 119.614, z: -17.811 },
	       { x: -73.4512, y: 119.651, z: -17.813 },
	       { x: -73.5201, y: 119.706, z: -17.8435 },
	       { x: -73.583, y: 119.772, z: -17.8742 },
	       { x: -73.583, y: 119.772, z: -17.8742 },
	       { x: -73.6482, y: 119.824, z: -17.9118 },
	       { x: -73.7011, y: 119.866, z: -17.9392 },
	       { x: -73.7011, y: 119.866, z: -17.9392 },
	       { x: -73.7665, y: 119.888, z: -17.9642 },
	       { x: -73.8689, y: 119.89, z: -17.9572 },
	       { x: -73.8689, y: 119.89, z: -17.9572 },
	       { x: -73.9027, y: 119.787, z: -17.784 },
	       { x: -73.9002, y: 119.756, z: -17.7347 },
	       { x: -73.9002, y: 119.756, z: -17.7347 },
	       { x: -73.865, y: 119.677, z: -17.7113 },
	       { x: -73.828, y: 119.576, z: -17.6664 },
	       { x: -73.828, y: 119.576, z: -17.6664 },
	       { x: -73.7904, y: 119.501, z: -17.6383 },
	       { x: -73.7014, y: 119.48, z: -17.667 },
	       { x: -73.7014, y: 119.48, z: -17.667 },
	       { x: -73.7121, y: 119.486, z: -17.7021 },
	       { x: -73.7325, y: 119.503, z: -17.7239 } ];

var points = [];
var isRecording = false;

Leap.loop({enableGestures: true}, function(frame){
    if(frame.hands.length <= 0){
	return;
    }

    var hand = frame.hands[0];
    var finger = hand.indexFinger;
    var point = getFingertip(finger);

    if (!isRecording) {
	sketch.clear();
	points = [];
	sketch.setStrokeStyle(showColor);
	sketch.drawCircle(point.x, -point.y);

	return;
    }

    sketch.setStrokeStyle(drawColor);
    sketch.drawCircle(point.x, -point.y);

    points.push(point);
});

function getFingertip(finger){
    var point = {"x": finger.tipPosition[0],
		 "y": finger.tipPosition[1],
		 "z": finger.tipPosition[2]
		};
    return point;
}

// function transformXYZ(points) {
//     var X = [];
//     var Y = [];
//     var Z = [];

//     for (var i in points) {
// 	var p = points[i];
// 	X.push(p.x);
// 	Y.push(p.y);
// 	Z.push(p.z);
//     }

//     return {X: X, Y: Y, Z: Z};
// }
function changeOfPosition(data) {
    var n = data.length - 1;
    var d = [];
    for (var i = 0; i < n; i++) {
	d.push({
	    x: data[i+1].x - data[i].x,
	    y: data[i+1].y - data[i].y,
	    z: data[i+1].z - data[i].z
	});
    }
    return d;
}


function recordFinger(){
    if (isRecording) {
	console.log('end');

	var ts1 = changeOfPosition(points);
	var ts2 = changeOfPosition(sample);

	function distance(p1, p2) {
	    var x = Math.pow(p1.x - p2.x, 2);
	    var y = Math.pow(p1.y - p2.y, 2);
	    var z = Math.pow(p1.z - p2.z, 2);
	    var d = Math.sqrt(x + y + z);
	    return d;
	};

	var d = DTW.distance(ts1, ts2, distance);
	console.log('d:'+d);
	// compute cost
	
    } else {
	console.log('begin');
    }

    isRecording = !isRecording;
}    


$('#rec-button').click(recordFinger);
