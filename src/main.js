var $ = require('jquery');
var Leap = require('leapjs');
var Distance = require('./distance.js');
var Sketch = require('./sketch.js');

var showColor = '#87ceeb';
var drawColor = '#000080';

var sketch = new Sketch('sketch');
var samples = require('./test/data.json');
var points = [];
var isRecording = false;
var result = [];

// var samples = [
//     {
//     "name":"sample",
//     "points":
// 	[{x: 10, y: 200, z: 0},
// 	 {x: 20, y: 200, z: 0},
// 	 {x: 30, y: 200, z: 0},
// 	 {x: 40, y: 200, z: 0},
// 	 {x: 50, y: 200, z: 0},
// 	 {x: 70, y: 200, z: 0},
// 	 {x: 90, y: 200, z: 0},
// 	 {x: 110, y: 200, z: 0},
// 	 {x: 130, y: 200, z: 0},
// 	]
//     }
// ];

var query =[
	{
		"x": -167.321,
		"y": 262.213,
		"z": -49.5388
	},
	{
		"x": -167.328,
		"y": 262.24,
		"z": -49.5478
	},
	{
		"x": -167.347,
		"y": 262.275,
		"z": -49.5905
	},
	{
		"x": -167.356,
		"y": 262.282,
		"z": -49.6298
	},
	{
		"x": -167.338,
		"y": 262.22,
		"z": -49.7266
	},
	{
		"x": -167.262,
		"y": 262.107,
		"z": -49.8018
	},
	{
		"x": -167.208,
		"y": 262.033,
		"z": -49.8433
	},
	{
		"x": -167.064,
		"y": 261.842,
		"z": -49.917
	},
	{
		"x": -166.719,
		"y": 261.417,
		"z": -50.0495
	},
	{
		"x": -166.178,
		"y": 260.799,
		"z": -50.1896
	},
	{
		"x": -165.645,
		"y": 260.106,
		"z": -50.3897
	},
	{
		"x": -165.339,
		"y": 259.874,
		"z": -50.6126
	},
	{
		"x": -165.216,
		"y": 259.824,
		"z": -50.8343
	},
	{
		"x": -164.828,
		"y": 259.447,
		"z": -51.5243
	},
	{
		"x": -164.223,
		"y": 258.67,
		"z": -51.9256
	},
	{
		"x": -163.807,
		"y": 258.265,
		"z": -52.0562
	},
	{
		"x": -163.277,
		"y": 257.76,
		"z": -52.2815
	},
	{
		"x": -162.225,
		"y": 256.703,
		"z": -52.295
	},
	{
		"x": -161.74,
		"y": 256.336,
		"z": -52.2554
	},
	{
		"x": -160.688,
		"y": 255.335,
		"z": -52.4139
	},
	{
		"x": -159.645,
		"y": 254.278,
		"z": -52.5025
	},
	{
		"x": -158.787,
		"y": 253.388,
		"z": -52.6008
	},
	{
		"x": -158.098,
		"y": 252.845,
		"z": -52.786
	},
	{
		"x": -157.252,
		"y": 251.933,
		"z": -53.0986
	},
	{
		"x": -156.577,
		"y": 251.426,
		"z": -53.3232
	},
	{
		"x": -155.611,
		"y": 250.682,
		"z": -53.5842
	},
	{
		"x": -155.022,
		"y": 250.188,
		"z": -53.6827
	},
	{
		"x": -153.696,
		"y": 248.87,
		"z": -53.8673
	},
	{
		"x": -152.558,
		"y": 247.711,
		"z": -54.0002
	},
	{
		"x": -151.507,
		"y": 246.923,
		"z": -53.9704
	},
	{
		"x": -150.279,
		"y": 245.418,
		"z": -54.1289
	},
	{
		"x": -148.918,
		"y": 243.69,
		"z": -54.2226
	},
	{
		"x": -148.344,
		"y": 243.135,
		"z": -54.1327
	},
	{
		"x": -147.167,
		"y": 241.863,
		"z": -53.88
	},
	{
		"x": -146.202,
		"y": 240.988,
		"z": -53.9075
	},
	{
		"x": -145.419,
		"y": 240.298,
		"z": -53.9982
	},
	{
		"x": -144.499,
		"y": 239.295,
		"z": -54.0742
	},
	{
		"x": -143.29,
		"y": 237.827,
		"z": -54.0624
	},
	{
		"x": -141.997,
		"y": 236.092,
		"z": -53.8913
	},
	{
		"x": -141.266,
		"y": 235.223,
		"z": -53.7155
	},
	{
		"x": -140.089,
		"y": 233.928,
		"z": -53.4904
	},
	{
		"x": -138.896,
		"y": 232.47,
		"z": -53.4937
	},
	{
		"x": -137.774,
		"y": 230.935,
		"z": -53.5423
	},
	{
		"x": -137.023,
		"y": 229.764,
		"z": -53.669
	},
	{
		"x": -135.375,
		"y": 228.036,
		"z": -53.5925
	},
	{
		"x": -134.599,
		"y": 226.971,
		"z": -53.5459
	},
	{
		"x": -133.29,
		"y": 225.213,
		"z": -53.6092
	},
	{
		"x": -132.309,
		"y": 223.679,
		"z": -53.414
	},
	{
		"x": -131.252,
		"y": 221.674,
		"z": -53.3703
	},
	{
		"x": -130.136,
		"y": 219.47,
		"z": -53.3301
	},
	{
		"x": -127.871,
		"y": 214.841,
		"z": -53.9269
	},
	{
		"x": -127.396,
		"y": 213.796,
		"z": -53.9979
	},
	{
		"x": -126.046,
		"y": 211.356,
		"z": -53.8043
	},
	{
		"x": -125.428,
		"y": 210.254,
		"z": -53.8004
	},
	{
		"x": -123.414,
		"y": 206.76,
		"z": -53.9292
	},
	{
		"x": -122.273,
		"y": 204.778,
		"z": -54.0304
	},
	{
		"x": -120.769,
		"y": 202.48,
		"z": -54.2264
	},
	{
		"x": -119.958,
		"y": 201.251,
		"z": -54.3402
	},
	{
		"x": -118.459,
		"y": 198.891,
		"z": -54.6354
	},
	{
		"x": -117.161,
		"y": 197.182,
		"z": -54.7932
	},
	{
		"x": -115.468,
		"y": 194.841,
		"z": -54.7342
	},
	{
		"x": -113.821,
		"y": 192.582,
		"z": -54.5881
	},
	{
		"x": -112.609,
		"y": 190.866,
		"z": -54.5484
	},
	{
		"x": -111.142,
		"y": 188.737,
		"z": -54.6957
	},
	{
		"x": -110.54,
		"y": 187.864,
		"z": -54.7572
	},
	{
		"x": -109.266,
		"y": 186.14,
		"z": -54.7915
	},
	{
		"x": -107.955,
		"y": 184.404,
		"z": -54.8427
	},
	{
		"x": -106.698,
		"y": 182.692,
		"z": -55.0594
	},
	{
		"x": -105.48,
		"y": 180.897,
		"z": -55.3411
	},
	{
		"x": -104.19,
		"y": 179.074,
		"z": -55.486
	},
	{
		"x": -102.954,
		"y": 177.177,
		"z": -55.6929
	},
	{
		"x": -102.358,
		"y": 176.304,
		"z": -55.7764
	},
	{
		"x": -101.138,
		"y": 174.663,
		"z": -55.8453
	},
	{
		"x": -99.7717,
		"y": 172.903,
		"z": -55.8237
	},
	{
		"x": -98.5657,
		"y": 171.409,
		"z": -55.9158
	},
	{
		"x": -97.2831,
		"y": 169.991,
		"z": -56.2315
	},
	{
		"x": -95.9569,
		"y": 168.604,
		"z": -56.5869
	},
	{
		"x": -95.2403,
		"y": 167.918,
		"z": -56.8109
	},
	{
		"x": -93.8787,
		"y": 166.603,
		"z": -57.0563
	},
	{
		"x": -92.3384,
		"y": 165.404,
		"z": -57.0382
	},
	{
		"x": -90.9862,
		"y": 164.426,
		"z": -57.115
	},
	{
		"x": -89.8664,
		"y": 163.565,
		"z": -57.1399
	},
	{
		"x": -88.7211,
		"y": 162.833,
		"z": -57.1696
	},
	{
		"x": -87.5475,
		"y": 162.204,
		"z": -57.2916
	},
	{
		"x": -86.9755,
		"y": 161.918,
		"z": -57.3491
	},
	{
		"x": -85.7424,
		"y": 161.416,
		"z": -57.5537
	},
	{
		"x": -84.4491,
		"y": 160.932,
		"z": -57.7692
	},
	{
		"x": -83.17,
		"y": 160.512,
		"z": -57.9729
	},
	{
		"x": -81.9004,
		"y": 160.254,
		"z": -58.1102
	},
	{
		"x": -80.6647,
		"y": 160.382,
		"z": -58.1914
	},
	{
		"x": -79.4154,
		"y": 160.571,
		"z": -58.2849
	},
	{
		"x": -78.7276,
		"y": 160.71,
		"z": -58.2927
	},
	{
		"x": -77.3133,
		"y": 160.954,
		"z": -58.3337
	},
	{
		"x": -75.8388,
		"y": 161.04,
		"z": -58.3455
	},
	{
		"x": -74.4776,
		"y": 161.125,
		"z": -58.3533
	},
	{
		"x": -73.2028,
		"y": 161.294,
		"z": -58.5787
	},
	{
		"x": -72.6111,
		"y": 161.376,
		"z": -58.6647
	},
	{
		"x": -70.7646,
		"y": 161.7,
		"z": -58.8824
	},
	{
		"x": -70.1188,
		"y": 161.896,
		"z": -58.8383
	},
	{
		"x": -68.8645,
		"y": 162.277,
		"z": -58.9591
	},
	{
		"x": -67.6871,
		"y": 162.829,
		"z": -58.8027
	},
	{
		"x": -66.348,
		"y": 163.36,
		"z": -58.7334
	},
	{
		"x": -64.9762,
		"y": 163.922,
		"z": -58.9069
	},
	{
		"x": -63.718,
		"y": 164.644,
		"z": -58.8944
	},
	{
		"x": -63.1125,
		"y": 164.935,
		"z": -58.8794
	},
	{
		"x": -61.8362,
		"y": 165.564,
		"z": -58.9516
	},
	{
		"x": -60.6341,
		"y": 166.153,
		"z": -58.8814
	},
	{
		"x": -59.3966,
		"y": 166.593,
		"z": -58.9491
	},
	{
		"x": -58.2608,
		"y": 166.852,
		"z": -59.1261
	},
	{
		"x": -57.2301,
		"y": 167.185,
		"z": -59.3964
	},
	{
		"x": -55.9973,
		"y": 167.566,
		"z": -59.7565
	},
	{
		"x": -55.3202,
		"y": 167.729,
		"z": -59.9024
	},
	{
		"x": -54.0465,
		"y": 168.093,
		"z": -60.3584
	},
	{
		"x": -52.9489,
		"y": 168.478,
		"z": -60.5892
	},
	{
		"x": -51.7823,
		"y": 169.001,
		"z": -60.8501
	},
	{
		"x": -50.6326,
		"y": 169.78,
		"z": -61.1137
	},
	{
		"x": -49.5095,
		"y": 170.844,
		"z": -61.0676
	},
	{
		"x": -48.9955,
		"y": 171.478,
		"z": -61.1571
	},
	{
		"x": -48.0606,
		"y": 172.721,
		"z": -61.2198
	},
	{
		"x": -47.0718,
		"y": 174.062,
		"z": -61.2138
	},
	{
		"x": -46.2246,
		"y": 175.656,
		"z": -61.4177
	},
	{
		"x": -45.4189,
		"y": 177.361,
		"z": -61.6442
	},
	{
		"x": -45.4189,
		"y": 177.361,
		"z": -61.6442
	},
	{
		"x": -43.8625,
		"y": 180.421,
		"z": -62.5879
	},
	{
		"x": -43.3489,
		"y": 181.359,
		"z": -62.7626
	},
	{
		"x": -42.4061,
		"y": 183.159,
		"z": -63.1561
	},
	{
		"x": -41.5798,
		"y": 184.808,
		"z": -63.3309
	},
	{
		"x": -40.755,
		"y": 186.416,
		"z": -63.5754
	},
	{
		"x": -39.9259,
		"y": 188.057,
		"z": -63.7289
	},
	{
		"x": -39.1358,
		"y": 189.684,
		"z": -63.8916
	},
	{
		"x": -38.733,
		"y": 190.465,
		"z": -63.9865
	},
	{
		"x": -37.8949,
		"y": 192.036,
		"z": -64.0688
	},
	{
		"x": -36.9832,
		"y": 193.499,
		"z": -64.3837
	},
	{
		"x": -36.1514,
		"y": 194.813,
		"z": -64.7176
	},
	{
		"x": -35.3359,
		"y": 196.111,
		"z": -64.9771
	},
	{
		"x": -34.4666,
		"y": 197.602,
		"z": -65.3802
	},
	{
		"x": -33.6658,
		"y": 199.072,
		"z": -65.5106
	},
	{
		"x": -33.3106,
		"y": 199.761,
		"z": -65.5004
	},
	{
		"x": -32.5083,
		"y": 201.106,
		"z": -65.6728
	},
	{
		"x": -31.7716,
		"y": 202.459,
		"z": -65.8105
	},
	{
		"x": -31.1874,
		"y": 203.735,
		"z": -65.7502
	},
	{
		"x": -30.6236,
		"y": 205.103,
		"z": -65.8274
	},
	{
		"x": -30.036,
		"y": 206.37,
		"z": -65.8991
	},
	{
		"x": -29.5194,
		"y": 207.641,
		"z": -65.92
	},
	{
		"x": -29.2544,
		"y": 208.515,
		"z": -66.0671
	},
	{
		"x": -28.6726,
		"y": 209.994,
		"z": -66.0107
	},
	{
		"x": -28.1381,
		"y": 211.449,
		"z": -66.1136
	},
	{
		"x": -27.6211,
		"y": 212.839,
		"z": -66.3587
	},
	{
		"x": -27.1304,
		"y": 214.273,
		"z": -66.2861
	},
	{
		"x": -26.6543,
		"y": 215.448,
		"z": -66.1664
	},
	{
		"x": -26.3386,
		"y": 216.223,
		"z": -66.1023
	},
	{
		"x": -26.1903,
		"y": 216.601,
		"z": -66.0844
	},
	{
		"x": -26.01,
		"y": 217.358,
		"z": -65.936
	},
	{
		"x": -25.9157,
		"y": 217.937,
		"z": -65.7886
	},
	{
		"x": -25.8623,
		"y": 218.385,
		"z": -65.6652
	},
	{
		"x": -25.8109,
		"y": 218.716,
		"z": -65.5828
	},
	{
		"x": -25.7824,
		"y": 218.93,
		"z": -65.5214
	},
	{
		"x": -25.7732,
		"y": 218.997,
		"z": -65.5049
	},
	{
		"x": -25.7279,
		"y": 219.021,
		"z": -65.5101
	},
	{
		"x": -25.6842,
		"y": 219.015,
		"z": -65.5223
	},
	{
		"x": -25.6655,
		"y": 218.923,
		"z": -65.5651
	},
	{
		"x": -25.6958,
		"y": 218.723,
		"z": -65.6429
	},
	{
		"x": -25.6846,
		"y": 218.38,
		"z": -65.7244
	},
	{
		"x": -25.6728,
		"y": 218.004,
		"z": -65.8323
	},
	{
		"x": -25.6628,
		"y": 217.8,
		"z": -65.8947
	},
	{
		"x": -25.5673,
		"y": 217.335,
		"z": -66.1191
	},
	{
		"x": -25.5289,
		"y": 216.967,
		"z": -66.2457
	},
	{
		"x": -25.4966,
		"y": 216.645,
		"z": -66.353
	},
	{
		"x": -25.4872,
		"y": 216.378,
		"z": -66.4652
	},
	{
		"x": -25.4509,
		"y": 216.121,
		"z": -66.5201
	},
	{
		"x": -25.4204,
		"y": 215.958,
		"z": -66.5421
	},
	{
		"x": -25.4313,
		"y": 215.903,
		"z": -66.5445
	},
	{
		"x": -25.4392,
		"y": 215.854,
		"z": -66.5873
	},
	{
		"x": -25.4814,
		"y": 215.815,
		"z": -66.7817
	},
	{
		"x": -25.5593,
		"y": 216.234,
		"z": -67.1635
	},
	{
		"x": -25.6762,
		"y": 218.215,
		"z": -67.7616
	},
	{
		"x": -25.5343,
		"y": 221.751,
		"z": -68.7448
	},
	{
		"x": -25.3586,
		"y": 224.115,
		"z": -69.0733
	},
	{
		"x": -24.4856,
		"y": 230.096,
		"z": -68.3418
	},
	{
		"x": -22.7,
		"y": 237.913,
		"z": -68.7193
	},
	{
		"x": -19.9472,
		"y": 246.903,
		"z": -67.8587
	},
	{
		"x": -16.0442,
		"y": 257.66,
		"z": -66.5365
	},
	{
		"x": -11.4119,
		"y": 269.072,
		"z": -64.2405
	},
	{
		"x": -8.45187,
		"y": 275.591,
		"z": -63.7488
	},
	{
		"x": -1.94323,
		"y": 287.725,
		"z": -61.0055
	},
	{
		"x": 5.25518,
		"y": 300.182,
		"z": -56.9497
	},
	{
		"x": 13.1108,
		"y": 311.163,
		"z": -52.3918
	},
	{
		"x": 20.9885,
		"y": 320.29,
		"z": -46.7293
	},
	{
		"x": 29.5015,
		"y": 327.457,
		"z": -42.1227
	},
	{
		"x": 37.6424,
		"y": 333.462,
		"z": -35.6678
	},
	{
		"x": 41.9273,
		"y": 336.267,
		"z": -33.0156
	},
	{
		"x": 41.9273,
		"y": 336.267,
		"z": -33.0156
	},
	{
		"x": 60.5452,
		"y": 336.937,
		"z": -20.96
	},
	{
		"x": 68.8351,
		"y": 334.295,
		"z": -16.0041
	},
	{
		"x": 77.47,
		"y": 328.431,
		"z": -9.95626
	},
	{
		"x": 86.8401,
		"y": 320.487,
		"z": -4.18986
	},
	{
		"x": 96.3638,
		"y": 311.369,
		"z": 1.93838
	},
	{
		"x": 101.681,
		"y": 305.942,
		"z": 4.30342
	},
	{
		"x": 110.683,
		"y": 291.447,
		"z": 9.10579
	},
	{
		"x": 118.797,
		"y": 275.499,
		"z": 13.3057
	},
	{
		"x": 126.763,
		"y": 258.948,
		"z": 16.6417
	},
	{
		"x": 133.029,
		"y": 239.766,
		"z": 18.6219
	},
	{
		"x": 135.455,
		"y": 231.945,
		"z": 20.6646
	},
	{
		"x": 140.441,
		"y": 216.377,
		"z": 22.8236
	},
	{
		"x": 144.761,
		"y": 203.089,
		"z": 25.6503
	},
	{
		"x": 148.594,
		"y": 190.529,
		"z": 27.6715
	},
	{
		"x": 149.53,
		"y": 179.036,
		"z": 28.532
	},
	{
		"x": 150.093,
		"y": 171.034,
		"z": 30.047
	},
	{
		"x": 150.575,
		"y": 164.176,
		"z": 31.3827
	},
	{
		"x": 150.577,
		"y": 160.613,
		"z": 31.7406
	},
	{
		"x": 148.666,
		"y": 155.471,
		"z": 33.8089
	},
	{
		"x": 149.061,
		"y": 154.073,
		"z": 37.0461
	},
	{
		"x": 148.136,
		"y": 151.796,
		"z": 38.0644
	},
	{
		"x": 147.751,
		"y": 150.557,
		"z": 38.5004
	},
	{
		"x": 147.381,
		"y": 148.882,
		"z": 39.5832
	},
	{
		"x": 147.57,
		"y": 148.673,
		"z": 40.2934
	},
	{
		"x": 146.745,
		"y": 147.905,
		"z": 40.3076
	},
	{
		"x": 146.495,
		"y": 147.262,
		"z": 41.007
	},
	{
		"x": 146.461,
		"y": 147.061,
		"z": 41.2065
	},
	{
		"x": 146.456,
		"y": 146.899,
		"z": 41.4033
	},
	{
		"x": 146.37,
		"y": 146.695,
		"z": 41.5984
	},
	{
		"x": 146.777,
		"y": 147.118,
		"z": 41.7314
	},
	{
		"x": 146.956,
		"y": 147.487,
		"z": 42.054
	},
	{
		"x": 146.633,
		"y": 147.383,
		"z": 42.2887
	},
	{
		"x": 146.433,
		"y": 147.439,
		"z": 42.3731
	},
	{
		"x": 146.345,
		"y": 147.939,
		"z": 42.4508
	},
	{
		"x": 146.474,
		"y": 149.189,
		"z": 42.0652
	},
	{
		"x": 146.668,
		"y": 150.357,
		"z": 41.6015
	},
	{
		"x": 146.821,
		"y": 151.17,
		"z": 41.2966
	},
	{
		"x": 146.837,
		"y": 151.779,
		"z": 41.0651
	},
	{
		"x": 146.707,
		"y": 152.006,
		"z": 40.9512
	},
	{
		"x": 146.399,
		"y": 152.72,
		"z": 41.0437
	},
	{
		"x": 146.309,
		"y": 153.296,
		"z": 41.1188
	},
	{
		"x": 146.352,
		"y": 153.879,
		"z": 40.9576
	},
	{
		"x": 146.311,
		"y": 154.275,
		"z": 40.7853
	},
	{
		"x": 146.214,
		"y": 154.481,
		"z": 40.6439
	},
	{
		"x": 146.237,
		"y": 154.594,
		"z": 40.5952
	},
	{
		"x": 146.309,
		"y": 154.865,
		"z": 40.5073
	},
	{
		"x": 146.208,
		"y": 155.113,
		"z": 40.3792
	},
	{
		"x": 146.028,
		"y": 155.269,
		"z": 40.2519
	},
	{
		"x": 145.753,
		"y": 155.577,
		"z": 40.136
	},
	{
		"x": 145.565,
		"y": 155.982,
		"z": 40.0893
	},
	{
		"x": 145.327,
		"y": 156.161,
		"z": 40.1016
	},
	{
		"x": 145.21,
		"y": 156.282,
		"z": 40.1136
	},
	{
		"x": 144.778,
		"y": 156.71,
		"z": 40.1433
	}
];


Leap.loop({enableGestures: true}, function(frame){
    if(frame.hands.length <= 0){
	return;
    }

    var hand = frame.hands[0];
    var finger = hand.indexFinger;
    var point = getFingertip(finger);

    if (!isRecording) {
	sketch.clear();
	points = [];
	sketch.setStrokeStyle(showColor);
	sketch.drawCircle(point.x, -point.y);

	return;
    }

    sketch.setStrokeStyle(drawColor);
    sketch.drawCircle(point.x, -point.y);

    points.push(point);
});

function getFingertip(finger){
    var point = {
	"x": finger.tipPosition[0],
	"y": finger.tipPosition[1],
	"z": finger.tipPosition[2]
    };
    return point;
}

function searchTimeSeries(tsQuery) {
    // スコアの計算
    // 全データ (db) との類似度を求める
    var n = samples.length;
    var score = [];

    for (var i = 0; i < n; i++){
	var target = samples[i].points;

	var tdist = Distance.temporalDistance(tsQuery, target);
	var sdist = Distance.spatialDistance(tsQuery, target);

	var td = tdist;
	var sdX = sdist.x;
	var sdY = sdist.y;

    //console.log(points);
    //console.log(JSON.stringify(points,null,'\t'));

	score.push({
	    name: samples[i].name,
	    score: sdX*sdY*td,
	    score_s: sdX*sdY,
	    score_t: td,
	    // parseInt(0.7*(sdX*sdY)+0.3*td)
	    points: samples[i].points
	});
    }
    score.sort(function(a,b){
    	if(a.score < b.score) return -1;
    	if(a.score > b.score) return 1;
    	return 0;
    });    
     console.log(score);
    return score;
};

function distance(p1, p2) {
    var p = Math.pow(p1 - p2, 2);
    var d = Math.sqrt(p);
    return d;
};

function recordFinger(){
    if (isRecording) {
	console.log('end');
    } else {
	console.log('begin');
	$("#output").empty();
    }
    isRecording = !isRecording;
}

// 指定した canvas 要素に時系列データをアニメーションで描く
// id: 時系列データを表示したい canvas 要素の id
// points: 時系列データ ([{x: 1, y: 2, z: 3}, ... ] のような配列)
function drawTimeSeriesData(id, points) {
    var cs  = document.getElementById(id);
    var ctx = cs.getContext('2d');

    var w = cs.width;
    var h = cs.height;
    
    // processing の map 関数と同じやつ
    function mapValue(value, start1, stop1, start2, stop2) {
	var ratio = (value - start1) / (stop1 - start1);
	return start2 + ratio * (stop2 - start2);
    }

    // 時系列データ points の i 番目の点を表示するためのカウンタ
    var i = 0;

    function render() {
	var p = points[i];
	var x = mapValue(p.x, -256, 256, 0, w);
	var y = mapValue(p.y, 0, 550, h, 0);

	ctx.clearRect(0, 0, w, h);

	ctx.strokeStyle = drawColor;
	ctx.beginPath();
	ctx.arc(x, y, 5, 0, Math.PI*2, false);
	ctx.stroke();
	// console.log('draw point');
	// console.log(x);
	// console.log(y);

	i++;
	if (points.length <= i) {
	    i = 0;
	}
    }
    setInterval(render, 1000/60.0);
}

function searchData(){
    if(isRecording){
	isRecording = false;
	console.log('search start');
//	result = searchTimeSeries(points);
	result = searchTimeSeries(query);
	console.log(result);
	$.each(result, function(index, item){
	    var imgPath = './img/' + item.name + '.png';
	    var img = '<img src="' + imgPath + '">';
  
	    $("#output").append(
		$("<div/>").attr('class', 'view').append(img),
		$("<div/>").attr('class', 'result').
		    append('<p>'+item.name+'</p>').
		    append('<br/>').
		    append("total score").
		    append('<br/>').
		    append(item.score).
		    append('<br/>').
		    append("spatial score").
		    append('<br/>').
		    append(item.score_s).
		    append('<br/>').
		    append("temporal score").
		    append('<br/>').
		    append(item.score_t)
	    ).trigger('create');
	    $('.view').show(img);

	    // 動的にキャンバスを作成
	    var $canvas = $('<canvas>').attr({
		id: 'canvas-' + item.name,
		width: 160,
		height: 160
	    });
	    // 任意の位置にキャンバスを追加
//	    $("#output").append($canvas);
	    $("#output").append(
		$("<div/>").attr('class', 'move').append($canvas)
	    ).trigger('create');
	    // 指定した id のキャンバスに points を描く
	    drawTimeSeriesData('canvas-' + item.name, item.points);
	});
	console.log('search end');
    }else{
	console.log("nothing");
    }
}

$('#rec-button').click(recordFinger);
$('#search-button').click(searchData);
