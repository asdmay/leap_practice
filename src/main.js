var DTW = require('dtw');
var dtw = new DTW();
var $ = require('jquery');
var Leap = require('leapjs');
var Sketch = require('./sketch.js');
var showColor = '#87ceeb';
var drawColor = '#000080';
var sketch = new Sketch('sketch');

var xs =[-131.078,-131.121,-130.998,-132.043,-131.751,-131.559,-131.754,-131.656,-131.667,-131.582,-131.311,-131.298,-131.156,-130.859,-130.327,-129.953,-129.639,-128.84,-127.464,-126.391,-125.149,-123.709,-122.706,-120.942,-118.873,-116.8,-114.986,-112.534,-109.731,-108.405,-105.012,-102.094,-99.3429,-96.6649,-93.6136,-90.3042,-88.5925,-84.6087,-81.3563,-77.8534,-73.916,-69.7456,-67.8189,-63.8966,-59.8594,-53.0297,-46.8181,-43.4335,-41.935,-38.9326,-35.5137,-32.1937,-28.9996,-25.3157,-22.2056,-20.6618,-17.7129,-14.8716,-11.9481,-8.98091,-5.94689,-3.02841,-1.6465,1.22739,4.07799,6.97377,9.93517,11.5234,14.3832,17.1432,20.135,20.135,25.5418,28.7257,31.8416,34.7482,36.2166,38.9797,41.6862,44.3163,46.9696,49.4331,50.6707,55.7411,58.3162,60.9111,62.252,64.9735,69.4248,70.7824,73.6706,76.4251,79.1873,80.4774,83.8766,84.8743,89.9319,92.329,96.8079,97.8708,100.082,102.204,104.597,106.453,108.459,109.969,110.718,112.398,113.768,116.025,118.775,120.223,121.188,123.193,124.085,125.198,125.642,126.75,131.08,130.992,130.356,131.951,130.154,130.392,130.642,131.612,132.111,130.176];

var ys =[138.646,139.451,139.276,140.383,140.813,141.006,141.693,141.722,141.297,141.012,140.599,140.242,139.825,139.472,139.168,139.237,139.257,139.321,139.114,139.265,139.399,139.595,139.437,139.376,139.115,138.964,138.929,138.692,138.275,138.182,137.117,136.285,135.876,135.525,135.094,134.391,134.005,131.117,131.885,132.165,132.264,131.981,132.001,131.412,130.951,132.695,132.62,132.222,131.997,131.764,131.191,130.536,129.968,129.291,128.765,128.606,128.272,128.709,129.076,129.499,129.874,130.031,130.177,130.396,130.621,130.592,130.517,130.388,130.401,130.51,130.807,130.807,130.643,130.768,131.038,131.419,131.554,131.876,132.199,132.735,133.251,133.62,133.747,134.76,134.841,135.133,135.388,135.692,137.316,137.59,138.29,139.415,139.822,139.811,139.625,139.667,140.461,140.303,139.468,139.113,138.345,137.822,138.546,138.3,138.045,137.626,137.735,137.937,137.683,137.8,139.808,141.135,140.605,141.544,140.633,140.898,141.166,141.067,140.313,140.42,143.774,147.283,143.887,146.928,148.307,148.647,148.236,141.169];

var zs =[-21.6167,-18.8727,-18.9446,-20.4801,-18.4008,-18.1653,-18.4287,-19.5864,-19.6209,-19.5994,-19.7573,-19.888,-19.8231,-19.8546,-20.4711,-20.8325,-21.0936,-21.9433,-23.4024,-24.7197,-25.7699,-26.8645,-27.4602,-28.5953,-29.7471,-30.7249,-31.8069,-32.9277,-33.9671,-34.4193,-35.4661,-36.3274,-37.1351,-37.6561,-38.5416,-39.4153,-39.8292,-41.6123,-41.7537,-41.8053,-41.7077,-41.8808,-42.0913,-42.441,-42.7765,-44.2729,-43.5921,-43.1512,-43.0213,-42.9091,-42.9804,-43.3668,-44.0585,-45.181,-46.3028,-46.4007,-46.4256,-46.1915,-46.4276,-46.7513,-47.2076,-47.0511,-47.145,-47.481,-47.878,-48.1573,-48.3797,-48.0609,-47.9536,-47.9804,-48.0564,-48.0564,-48.0975,-47.989,-47.7966,-47.8488,-47.8337,-47.7781,-47.3226,-46.9913,-46.5357,-46.2039,-45.9366,-45.6793,-45.4754,-45.5694,-45.6204,-45.4719,-44.8958,-44.5913,-44.1098,-43.1938,-43.0266,-43.0387,-42.4981,-42.0313,-42.6007,-42.776,-42.2653,-42.0368,-41.5535,-40.6639,-40.0276,-39.4004,-38.0993,-36.922,-36.4493,-35.5368,-34.3685,-33.5482,-28.7987,-26.6227,-27.2249,-25.6816,-25.7807,-24.604,-23.4119,-23.7243,-22.9121,-23.4481,-21.942,-19.9593,-18.1961,-13.5683,-10.2798,-8.78393,-7.75913,-9.68131];

var points = [];
var isRecording = false;

Leap.loop({enableGestures: true}, function(frame){
    if(frame.hands.length <= 0){
	return;
    }

    var hand = frame.hands[0];
    var finger = hand.indexFinger;
    var point = getFingertip(finger);

    if (!isRecording) {
	sketch.clear();
	points = [];
	sketch.setStrokeStyle(showColor);
	sketch.drawCircle(point.x, -point.y);

	return;
    }

    sketch.setStrokeStyle(drawColor);
    sketch.drawCircle(point.x, -point.y);

    points.push(point);
});

function getFingertip(finger){
    var point = {"x": finger.tipPosition[0],
		 "y": finger.tipPosition[1],
		 "z": finger.tipPosition[2]
		};
    return point;
}

function transformXYZ(points) {
    var X = [];
    var Y = [];
    var Z = [];

    for (var i in points) {
	var p = points[i];
	X.push(p.x);
	Y.push(p.y);
	Z.push(p.z);
    }

    return {X: X, Y: Y, Z: Z};
}

function recordFinger(){
    if (isRecording) {
	console.log('end');

	// compute cost
	var point = transformXYZ(points);
	var costX = dtw.compute(point.X, xs);
	var costY = dtw.compute(point.Y, ys);
	var costZ = dtw.compute(point.Z, zs);
	console.log("Xc:" + costX, "Yc:" + costY, "Zc:" + costZ);
	console.log("X:" + point.X, "Y:" + point.Y, "Z:" + point.Z);
    } else {
	console.log('begin');
    }

    isRecording = !isRecording;
}    

$('#rec-button').click(recordFinger);
